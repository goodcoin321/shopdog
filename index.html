<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아트 갤러리 | Modern Art</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
        }
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-on-sale {
            background-color: #10B981; /* Emerald 500 */
            color: white;
        }
        .status-sold {
            background-color: #6B7280; /* Gray 500 */
            color: white;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 40;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            z-index: 50;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- 헤더 -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">
                <i class="fa-solid fa-palette mr-2 text-indigo-600"></i>
                모던 아트 갤러리
            </h1>
            <button id="admin-login-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                <i class="fa-solid fa-user-shield mr-2"></i>관리자
            </button>
        </nav>
    </header>

    <!-- 메인 콘텐츠: 그림 갤러리 -->
    <main class="container mx-auto px-6 py-12">
        <div id="painting-gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
            <!-- 그림 목록이 여기에 동적으로 추가됩니다. -->
            <div class="text-center col-span-full py-16">
                <i class="fa-solid fa-spinner fa-spin text-4xl text-indigo-500"></i>
                <p class="mt-4 text-lg text-gray-600">작품을 불러오는 중입니다...</p>
            </div>
        </div>
    </main>

    <!-- 푸터 -->
    <footer class="bg-gray-800 text-gray-300 mt-auto">
        <div class="container mx-auto px-6 py-8">
            <div class="flex flex-col items-center sm:flex-row sm:justify-between">
                <div class="text-center sm:text-left mb-4 sm:mb-0">
                    <h2 class="text-xl font-bold text-white">모던 아트 갤러리</h2>
                    <p class="text-sm text-gray-400">현대적인 컬렉터를 위한 시대를 초월한 작품들.</p>
                </div>
                <div class="flex space-x-4">
                    <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="fab fa-instagram fa-2x"></i></a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="fab fa-facebook-f fa-2x"></i></a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="fab fa-twitter fa-2x"></i></a>
                </div>
            </div>
            <div class="mt-8 border-t border-gray-700 pt-6 text-center text-sm text-gray-500">
                <p>&copy; 2025 모던 아트 갤러리. 모든 권리 보유.</p>
            </div>
        </div>
    </footer>


    <!-- 관리자 패널 (로그인 시 보임) -->
    <div id="admin-panel" class="hidden fixed bottom-8 right-8 z-40 flex flex-col items-end gap-4">
         <button id="add-painting-btn" class="bg-green-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-green-600 transition-transform hover:scale-110">
            <i class="fa-solid fa-plus"></i>
        </button>
        <button id="admin-logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors">
            로그아웃
        </button>
    </div>

    <!-- 관리자 로그인 및 작품 추가/수정 모달 -->
    <div id="modal-backdrop" class="modal-backdrop hidden">
        <!-- 로그인 폼 -->
        <div id="login-modal-content" class="modal-content hidden">
            <h2 class="text-2xl font-bold mb-6 text-center">관리자 로그인</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                    <input type="email" id="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                    <input type="password" id="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-md font-semibold hover:bg-indigo-700 transition-colors">로그인</button>
                <p id="login-error" class="text-red-500 text-sm mt-3 text-center"></p>
            </form>
        </div>

        <!-- 작품 폼 (추가/수정) -->
        <div id="painting-modal-content" class="modal-content hidden">
            <h2 id="painting-form-title" class="text-2xl font-bold mb-6 text-center">새 작품 추가</h2>
            <form id="painting-form">
                <input type="hidden" id="painting-id">
                <div class="mb-4">
                    <label for="imageUrl" class="block text-sm font-medium text-gray-700 mb-1">이미지 URL</label>
                    <input type="url" id="imageUrl" placeholder="https://example.com/image.jpg" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-1">작품명</label>
                    <input type="text" id="title" placeholder="노을지는 바다" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                 <div class="mb-4">
                    <label for="artist" class="block text-sm font-medium text-gray-700 mb-1">작가명</label>
                    <input type="text" id="artist" placeholder="홍길동" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="price" class="block text-sm font-medium text-gray-700 mb-1">가격 (원)</label>
                    <input type="number" id="price" placeholder="1000000" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-6">
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">판매 상태</label>
                    <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="판매중">판매중</option>
                        <option value="판매종료">판매종료</option>
                    </select>
                </div>
                <div class="flex gap-4">
                    <button type="button" id="cancel-btn" class="w-1/2 bg-gray-500 text-white py-2 rounded-md font-semibold hover:bg-gray-600">취소</button>
                    <button type="submit" class="w-1/2 bg-green-500 text-white py-2 rounded-md font-semibold hover:bg-green-600">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // 사용자의 Firebase 프로젝트 설정 정보
        const firebaseConfig = {
          apiKey: "AIzaSyBEhDKRgpWX74nXnO9fJZcntGPQYciqCXk",
          authDomain: "grimshop-1f929.firebaseapp.com",
          projectId: "grimshop-1f929",
          storageBucket: "grimshop-1f929.firebasestorage.app",
          messagingSenderId: "29515445458",
          appId: "1:29515445458:web:90c9a8cec7b4a528c5290b",
          measurementId: "G-82E38R8HBE"
        };

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const paintingsCollection = collection(db, "paintings");

        // UI 요소
        const gallery = document.getElementById('painting-gallery');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminPanel = document.getElementById('admin-panel');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const addPaintingBtn = document.getElementById('add-painting-btn');

        const modalBackdrop = document.getElementById('modal-backdrop');
        const loginModal = document.getElementById('login-modal-content');
        const paintingModal = document.getElementById('painting-modal-content');

        const loginForm = document.getElementById('login-form');
        const paintingForm = document.getElementById('painting-form');
        const cancelBtn = document.getElementById('cancel-btn');
        const loginError = document.getElementById('login-error');

        let currentUser = null;

        // 그림 목록 렌더링 함수
        function renderPaintings(paintings) {
            gallery.innerHTML = '';
            if (paintings.length === 0) {
                gallery.innerHTML = `<div class="text-center col-span-full py-16">
                    <i class="fa-solid fa-paintbrush text-4xl text-gray-400"></i>
                    <p class="mt-4 text-lg text-gray-600">등록된 작품이 없습니다. 관리자로 로그인하여 작품을 추가해주세요.</p>
                </div>`;
                return;
            }

            paintings.forEach(p => {
                const priceFormatted = new Intl.NumberFormat('ko-KR').format(p.price);
                const card = document.createElement('div');
                card.className = 'card bg-white rounded-lg shadow-md overflow-hidden relative';
                
                let adminButtons = '';
                if (currentUser) {
                    adminButtons = `
                        <div class="absolute top-2 right-2 flex gap-2">
                            <button data-id="${p.id}" class="edit-btn bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-blue-600"><i class="fa-solid fa-pencil"></i></button>
                            <button data-id="${p.id}" class="delete-btn bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-600"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="status-badge ${p.status === '판매종료' ? 'status-sold' : 'status-on-sale'}">${p.status}</div>
                    <img src="${p.imageUrl}" alt="${p.title}" class="w-full h-64 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/64748b?text=Image+Not+Found';">
                    <div class="p-5">
                        <h3 class="text-xl font-bold mb-1">${p.title}</h3>
                        <p class="text-md text-gray-600 mb-3">${p.artist}</p>
                        <p class="text-lg font-bold text-indigo-600">₩${priceFormatted}</p>
                    </div>
                    ${adminButtons}
                `;
                gallery.appendChild(card);
            });

            // 관리자 버튼에 이벤트 리스너 추가
            if (currentUser) {
                document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => handleEdit(e, paintings)));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
            }
        }

        // 실시간으로 그림 데이터 가져오기 (최신순 정렬)
        const q = query(paintingsCollection, orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const paintings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderPaintings(paintings);
        }, (error) => {
            console.error("데이터를 불러오는 중 오류 발생: ", error);
            gallery.innerHTML = `<div class="text-center col-span-full py-16">
                    <i class="fa-solid fa-circle-exclamation text-4xl text-red-500"></i>
                    <p class="mt-4 text-lg text-gray-600">데이터를 불러오는데 실패했습니다.</p>
                    <p class="text-sm text-gray-500 mt-2">Firestore 색인(index) 문제가 발생했을 수 있습니다. 콘솔의 에러 메시지를 확인하세요.</p>
                </div>`;
        });

        // 인증 상태 변경 감지 (로그인/로그아웃)
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                adminLoginBtn.classList.add('hidden');
                adminPanel.classList.remove('hidden');
            } else {
                adminLoginBtn.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }
            // 로그인 상태가 바뀌면 관리자 버튼을 표시/숨기기 위해 목록을 다시 렌더링
            const q = query(paintingsCollection, orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const paintings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPaintings(paintings);
            });
        });

        // 모달 창 열기/닫기 함수
        function openModal(modalContent) {
            modalBackdrop.classList.remove('hidden');
            modalContent.classList.remove('hidden');
        }

        function closeModal() {
            modalBackdrop.classList.add('hidden');
            loginModal.classList.add('hidden');
            paintingModal.classList.add('hidden');
            paintingForm.reset();
            document.getElementById('painting-id').value = '';
        }

        adminLoginBtn.addEventListener('click', () => openModal(loginModal));
        addPaintingBtn.addEventListener('click', () => {
            document.getElementById('painting-form-title').innerText = '새 작품 추가';
            paintingForm.reset();
            document.getElementById('painting-id').value = '';
            openModal(paintingModal);
        });
        cancelBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) closeModal();
        });

        // 로그인 처리 함수
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal();
            } catch (error) {
                console.error("로그인 실패:", error);
                loginError.textContent = '이메일 또는 비밀번호가 올바르지 않습니다.';
            }
        });

        // 로그아웃 처리 함수
        adminLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("로그아웃 실패:", error);
            }
        });

        // 작품 추가/수정 처리 함수
        paintingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const paintingId = document.getElementById('painting-id').value;
            const paintingData = {
                imageUrl: document.getElementById('imageUrl').value,
                title: document.getElementById('title').value,
                artist: document.getElementById('artist').value,
                price: Number(document.getElementById('price').value),
                status: document.getElementById('status').value,
            };

            try {
                if (paintingId) { // 수정
                    const docRef = doc(db, "paintings", paintingId);
                    await updateDoc(docRef, paintingData);
                } else { // 추가
                    paintingData.createdAt = serverTimestamp();
                    await addDoc(paintingsCollection, paintingData);
                }
                closeModal();
            } catch (error) {
                console.error("작품 저장 실패:", error);
                alert("작품 저장에 실패했습니다.");
            }
        });
        
        // 작품 수정 버튼 클릭 처리
        function handleEdit(e, paintings) {
            const id = e.currentTarget.dataset.id;
            const painting = paintings.find(p => p.id === id);
            if (!painting) return;

            document.getElementById('painting-form-title').innerText = '작품 정보 수정';
            document.getElementById('painting-id').value = painting.id;
            document.getElementById('imageUrl').value = painting.imageUrl;
            document.getElementById('title').value = painting.title;
            document.getElementById('artist').value = painting.artist;
            document.getElementById('price').value = painting.price;
            document.getElementById('status').value = painting.status;
            
            openModal(paintingModal);
        }

        // 작품 삭제 버튼 클릭 처리
        async function handleDelete(e) {
            const id = e.currentTarget.dataset.id;
            // confirm()은 iframe 환경에서 작동하지 않을 수 있으므로, 실제 환경에서는 커스텀 모달로 대체하는 것이 좋습니다.
            if (window.confirm("정말로 이 작품을 삭제하시겠습니까?")) {
                try {
                    await deleteDoc(doc(db, "paintings", id));
                } catch (error) {
                    console.error("작품 삭제 실패:", error);
                    alert("작품 삭제에 실패했습니다.");
                }
            }
        }

    </script>
</body>
</html>
